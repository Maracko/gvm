#!/bin/bash

###############################################################################
# GENERATED VERSION! DO NOT CHANGE!                                           #
SCRIPTVERSION="$(git describe --tags --always)"
###############################################################################

# Update checks the published version of this script based on the SCRIPTVERSION
# variable. If the version is different, it will give the user the option to
# update the script. If the user chooses to update, it will download the new
# version and replace the old one. It will then re-run the script using the new
# version.
update() {

    GVMURL=$(printf "https://github.com/devnw/gvm/releases/download/%s/gvm" "$SCRIPTVERSION")
    SUMPATH=$(printf "%s.sum" "$GVMURL")
    EXPECTEDSUM=$(curl -sL "$SUMPATH")
   
    # shellcheck disable=SC2086
    FILESUM=$(cat $0 | shasum -a 256)

    if [[ "$EXPECTEDSUM" != "Not Found" ]]
    then
        if [[ "$EXPECTEDSUM" != "" && $FILESUM != "$EXPECTEDSUM" ]]
        then

            printf "New Version of GVM [%s] Available would you like to update? " "$SCRIPTVERSION"

            read -rp "[Yes: Y or y | No: Enter]? " yn

            # Only trigger on `Y` or `y`
            if [[ "$yn" == "Y" || "$yn" == "y" ]]
            then
                curl -sL "$GVMURL" > .gvm.tmp
                
                # shellcheck disable=SC2002
                DOWNLOADEDSUM=$(cat .gvm.tmp | shasum -a 256)
                
                if [[ $DOWNLOADEDSUM != "$EXPECTEDSUM" ]]
                then
                    printf "Checksum does not match new version of GVM [%s]\n" "$SCRIPTVERSION"
                    printf "Expected: %s\n" "$EXPECTEDSUM"
                    printf "Actual:   %s\n" "$DOWNLOADEDSUM"
                    exit 1
                fi

                if ! cat .gvm.tmp > "$0"
                then
                    rm .gvm.tmp
                    printf "Failed to move new version of GVM [%s]\n" "$SCRIPTVERSION"
                    exit 1
                fi
                rm .gvm.tmp

                printf "GVM [%s] has been updated\n" "$SCRIPTVERSION"
                printf "%s\n" "$@"
                if ! exec $0 "$@"
                then 
                    printf "Failed to execute new version of GVM [%s]\n" "$SCRIPTVERSION"
                    exit 1
                fi

                printf "Successful update and execution"
                exit 0
            fi
        fi
    fi
}

help() {
    printf "
    Go Version Manager [%s] \n
    Usage: gvm <version> \n
      To install or activate a released version
      Example: gvm  1.17.5\n

      To install or activate the development version
      Example: gvm next\n

      To update and activate an existing development version
      Example: gvm next --update\n" "$SCRIPTVERSION"
}

# Determine if the script is out of date and offer to update
update "$@"

if [[ "$1" == "" || "$1" ==  "help"  || "$1" == "-h" || "$1" == "--help" ]]
then
    help

    if [[ "$1" == ""  ]]
    then
        exit 1
    fi

    exit 0
fi

if [[ ! $1 =~ ^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$ ]]
then
    if [[ "$1" != "next" ]]
    then
        printf "%s is not a valid version\n" "$1"

        help

        exit 1
    fi
fi

wd=$(pwd)
gvmroot="$HOME/.gvm"
srcd="$gvmroot/next"
version="$1"
versionroot="$gvmroot/$version"
defaultgoroot="/usr/local/go"
golanggit="https://go.googlesource.com/go"
dlroot="https://dl.google.com/go/"
update=$2
branch="master"

function override() {
    if [[ -d $defaultgoroot ]]
    then
        printf "Removing existing %s\n" "$defaultgoroot"
        if ! sudo rm -rf $defaultgoroot
        then
            fail "$(printf "Unable to remove existing %s\n" "$defaultgoroot")"
        fi
    fi

    printf "Creating for %s to %s\n" "$defaultgoroot" "$gvmroot"
    if ! sudo mkdir -p $defaultgoroot
    then
        fail "$(printf "Unable to create new to symlink %s\n" "$defaultgoroot")"
    fi

    if ! sudo ln -sf "$gvmroot"/go "$defaultgoroot"
    then
        fail "$(printf "Unable to symlink new %s\n" "$defaultgoroot")"
    fi
}

function fail() {
    printf "%s\n" "$1"
    exit 1
}

arch="amd64"
if ! uname -a | grep "x86_64"&> /dev/null
then
    arch="arm64"
    printf "Configuring for %s Architecture\n" "$arch"
fi
    
if [[ "$OSTYPE" == "darwin"* ]]
then
    os="darwin"
elif [[ "$OSTYPE" == "linux"* ]]
then
    os="linux"
elif [[ "$OSTYPE" == "freebsd"* ]]
then
    os="freebsd"
else
    printf "Unsupported OS\n"
    exit 1
fi

if [[ ! -d "$gvmroot" ]]
then
        printf "Adding ~/.gvm directory for go installs\n"
        if ! mkdir "$gvmroot" 
        then
            fail "$(printf "Error creating %s\n" "$gvmroot")"
        fi
fi

# printf "Checking for existing %s\n" "$versionroot"
# if [[ ! -d "$gvmroot" ]]
# then
#     if ! mkdir "$symln"
#     then
#         fail "$(printf "Unable to create directory %s\n" "$symln")"
#     fi
# fi

if [[ "$version" == "next" ]]
then
    printf "Installing Go %s\n" "$version"
    if ! which go
    then
        fail "$(printf "Installing go from %s requires an existing go installation\n" "$golanggit")"
    fi

    if [[ ! -d "$srcd" ]]
    then
        mkdir "$srcd"
    fi

    if [[ ! -d "$srcd/go" ]]
    then
        printf "Cloning go source\n"
        if ! git clone "$golanggit" "$srcd/go"
        then
            fail "$("Error cloning %s\n" "$golanggit")"
        fi

        srcd=$srcd/go

        # Add update flag since source repo
        # did not already exist
        update="--update"
    fi
    
    if [[ "$update" == "--update" ]]
    then
        cd "$srcd" || exit 1

        if ! git checkout "$branch"
        then
            fail "$(printf "Checkout of %s failed\n" "$branch")"
        fi

        if ! git pull
        then
            fail "$(printf "git pull failed for %s\n" "$branch")"
        fi

        if ! cd "$srcd/src/"
        then
            fail "$(printf "Unable to move to %s\n" "$srcd/src/")"
        fi

        if ! ./all.bash
        then

            # Only fail if the go binary wasn't properly built
            if ! ../bin/go version
            then
                cd "$wd" || exit 1
                fail "$(printf "Failure installing go from %s\n" "$branch")"
            fi
        fi

        cd "$wd" || exit 1
    fi
    
    # Set correct path for symlink re-map
    lnsrc="$versionroot"
else
    if [[ ! -d "$versionroot" ]]
    then
        pkg="go$version.$os-$arch.tar.gz"
        url="$dlroot$pkg"
        
        printf "Downloading %s\n" "$url"
        if ! curl -f "$url" > "$pkg"
        then
            fail "$(printf "Unable to curl %s\n" "$url")"
        fi

        printf "Creating %s\n" "$versionroot"
        if ! mkdir -p "$versionroot"
        then
            fail "$(printf "Unable to create %s\n" "$versionroot")"
        fi

        if ! tar -C "$versionroot" -xzf "$pkg"
        then
            fail "$(printf "Unable to extract %s\n" "$pkg" rm -rf "$versionroot")"
        fi
            
        rm "$pkg"
    fi

    # Set correct path for symlink re-map
    lnsrc="$versionroot/go"
fi

printf "Updating symlink %s => %s\n" "$lnsrc" "$gvmroot"
if ! ln -sf "$lnsrc" "$gvmroot"
then
    fail "$(printf "Unable to symlink directory %s\n" "$lnsrc")"
fi

# Check to see if the default root exists and if it is a symlink
# prior to prompting the user to override it
if [[ ! -L $defaultgoroot/bin || ! -e $defaultgoroot/bin ]]
then
    read -rp "Do you wish to override /usr/local/go \
    [Yes: Y or y | No: Enter]? " yn

    # Only trigger on `Y` or `y`
    if [[ "$yn" == "Y" || "$yn" == "y" ]]
    then
        override
    fi
fi

if ! printf "%s" "$PATH" | grep -q "$gvmroot/go/bin"
then
    printf "Adding %s/bin to PATH\n" "$gvmroot/go"
    
    path=$(printf "export PATH=\"%s/bin:\$PATH\"" "$gvmroot/go")

    if [[ "$SHELL" == *"zsh" ]]
    then
        printf "%s" "$path" >> "$HOME/.zshrc"
        exec zsh
    else
        printf "%s" "$path" >> "$HOME/.bashrc"

        # shellcheck disable=SC1091
        source "$HOME"/.bashrc

        if uname -a | grep Ubuntu&> /dev/null
        then
            printf "For ubuntu you must run [source ~/.bashrc] or logout/login to complete path installation\n"
        fi
    fi
fi

if which go
then
    pathgo=$(which go)
    if [[ "$pathgo" != "$gvmroot/go/bin/go" ]]
    then
        printf "GVM is shadowed by %s in your PATH. Please update your PATH to use %s first\n" \
        "$pathgo" \
        "$gvmroot/go/bin"
    fi
fi